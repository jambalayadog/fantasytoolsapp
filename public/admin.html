<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - NHL Data</title>
    <link rel="stylesheet" href="/stylesheets/admin.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèí NHL Data Admin Console</h1>
            <p>Manage data updates and scheduler configuration</p>
        </div>

        <div class="content">
            <!-- Status Section -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">üìä</span>
                    <span>Current Status</span>
                </div>
                
                <div class="status-grid">
                    <div class="status-card">
                        <div class="label">Last Update</div>
                        <div class="value" id="last-update">Loading...</div>
                    </div>
                    <div class="status-card highlight">
                        <div class="label">Total Games</div>
                        <div class="value" id="total-games">-</div>
                    </div>
                    <div class="status-card">
                        <div class="label">Games Completed</div>
                        <div class="value" id="games-completed">-</div>
                    </div>
                    <div class="status-card">
                        <div class="label">Games In Progress</div>
                        <div class="value" id="games-in-progress">-</div>
                    </div>
                </div>
                
                <div class="status-grid season-grid">
                    <div class="status-card">
                        <div class="label">Season Start</div>
                        <div class="value" id="season-start">-</div>
                    </div>
                    <div class="status-card">
                        <div class="label">Season End</div>
                        <div class="value" id="season-end">-</div>
                    </div>
                    <div class="status-card">
                        <div class="label">Current Date</div>
                        <div class="value" id="current-date">-</div>
                    </div>
                    <div class="status-card highlight">
                        <div class="label">Current Week</div>
                        <div class="value" id="current-week">-</div>
                    </div>
                </div>
            </div>

            <!-- Data Management Section -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">üîß</span>
                    <span>Data Management</span>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="btn-backfill" onclick="runBackfill()">
                        Full Season
                    </button>
                    <button class="btn btn-success" id="btn-update" onclick="runUpdate()">
                        Update Week x3
                    </button>
                    <button class="btn btn-success" id="btn-update-week" onclick="runUpdateWeek()">
                        Update Week
                    </button>
                    <button class="btn btn-secondary" id="btn-refresh-status" onclick="refreshStatus()">
                        Refresh Status
                    </button>
                </div>

                <div class="output-box" id="output-box">
                    <pre id="output-content"></pre>
                </div>
            </div>

            <!-- Scheduler Section -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">‚è∞</span>
                    <span>Scheduler</span>
                </div>
                
                <div class="scheduler-status-wrapper">
                    <span class="scheduler-status-label">Status:</span>
                    <span class="status-indicator stopped" id="scheduler-status">
                        <span class="dot"></span>
                        <span>Stopped</span>
                    </span>
                </div>

                <div class="scheduler-controls">
                    <div class="control-group">
                        <label>Update Interval</label>
                        <select id="interval-select" onchange="updateSchedulerConfig()">
                            <option value="0.5">Every 30 seconds (TEST)</option>
                            <option value="1">Every 1 minute (TEST)</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="30" selected>Every 30 minutes</option>
                            <option value="60">Every 60 minutes</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Smart Mode (Check game times)</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="smart-mode" checked onchange="updateSchedulerConfig()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>Live Game Interval</label>
                        <select id="live-game-interval-select" onchange="updateSchedulerConfig()">
                            <option value="1">Every 1 minute</option>
                            <option value="2">Every 2 minutes</option>
                            <option value="5" selected>Every 5 minutes</option>
                            <option value="10">Every 10 minutes</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="20">Every 20 minutes</option>
                            <option value="30">Every 30 minutes</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Pre-Game Detection Window</label>
                        <select id="pregame-window-select" onchange="updateSchedulerConfig()">
                            <option value="5">5 minutes before</option>
                            <option value="10">10 minutes before</option>
                            <option value="15">15 minutes before</option>
                            <option value="30" selected>30 minutes before</option>
                            <option value="45">45 minutes before</option>
                            <option value="60">60 minutes before</option>
                        </select>
                    </div>
                </div>

                <div class="button-group spaced-top">
                    <button class="btn btn-success" id="btn-start-scheduler" onclick="toggleScheduler(true)">
                        Start Scheduler
                    </button>
                    <button class="btn btn-danger" id="btn-stop-scheduler" onclick="toggleScheduler(false)">
                        Stop Scheduler
                    </button>
                </div>

                <p class="info-note">
                    ‚ÑπÔ∏è Note: Scheduler changes apply immediately without server restart
                </p>
            </div>

            <!-- Recent Updates Log -->
            <div class="section">
                <div class="section-title">
                    <span class="emoji">üìà</span>
                    <span>Recent Updates</span>
                </div>
                
                <div class="logs-list" id="logs-list">
                    <p class="empty-message">No recent updates</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load initial status on page load
        window.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
        });

        async function refreshStatus() {
            try {
                const response = await fetch('/admin/api/status');
                const data = await response.json();
                
                // Update status cards
                if (data.metadata) {
                    // Format last update time
                    const lastUpdate = new Date(data.metadata.generatedAt);
                    const now = new Date();
                    const diffMs = now - lastUpdate;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    let timeAgo;
                    if (diffMins < 1) {
                        timeAgo = 'Just now';
                    } else if (diffMins < 60) {
                        timeAgo = `${diffMins} min ago`;
                    } else {
                        const diffHours = Math.floor(diffMins / 60);
                        if (diffHours < 24) {
                            timeAgo = `${diffHours} hr ago`;
                        } else {
                            timeAgo = lastUpdate.toLocaleDateString();
                        }
                    }
                    document.getElementById('last-update').textContent = timeAgo;
                    
                    // Game statistics
                    document.getElementById('total-games').textContent = data.metadata.totalGames || '-';
                    document.getElementById('games-completed').textContent = data.metadata.gamesCompleted || '-';
                    document.getElementById('games-in-progress').textContent = data.metadata.gamesInProgress || '0';
                    
                    // Season information
                    document.getElementById('season-start').textContent = data.metadata.seasonStart 
                        ? new Date(data.metadata.seasonStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : '-';
                    document.getElementById('season-end').textContent = data.metadata.seasonEnd 
                        ? new Date(data.metadata.seasonEnd).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : '-';
                    document.getElementById('current-date').textContent = data.metadata.currentDate 
                        ? new Date(data.metadata.currentDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : '-';
                    document.getElementById('current-week').textContent = data.metadata.currentWeek !== undefined 
                        ? `Week ${data.metadata.currentWeek + 1} of ${data.metadata.totalWeeks}`
                        : '-';
                }
                
                // Update scheduler status
                if (data.scheduler) {
                    const statusEl = document.getElementById('scheduler-status');
                    if (data.scheduler.enabled) {
                        statusEl.className = 'status-indicator running';
                        statusEl.innerHTML = '<span class="dot"></span><span>Running</span>';
                    } else {
                        statusEl.className = 'status-indicator stopped';
                        statusEl.innerHTML = '<span class="dot"></span><span>Stopped</span>';
                    }
                    
                    document.getElementById('interval-select').value = data.scheduler.interval || 30;
                    document.getElementById('smart-mode').checked = data.scheduler.smartMode !== false;
                    document.getElementById('live-game-interval-select').value = data.scheduler.liveGameInterval || 5;
                    document.getElementById('pregame-window-select').value = data.scheduler.pregameWindow || 30;
                }
                
                // Update logs
                if (data.logs && data.logs.length > 0) {
                    const logsHtml = data.logs.reverse().map(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        const date = new Date(log.timestamp).toLocaleDateString();
                        
                        // Determine log type and label
                        let label, emoji;
                        if (log.type === 'auto-backfill') {
                            emoji = 'üîß';
                            label = `Auto-Backfill (${log.reason || 'startup'})`;
                        } else if (log.type === 'backfill') {
                            emoji = 'üîÑ';
                            label = 'Backfill';
                        } else if (log.type === 'week') {
                            emoji = 'üìÖ';
                            label = 'Week Update';
                        } else {
                            emoji = '‚ö°';
                            label = 'Update';
                        }
                        
                        // Determine status class
                        const statusClass = log.status === 'success' || log.success ? 'success' : 'error';
                        
                        return `
                            <div class="log-entry ${statusClass}">
                                <div class="timestamp">${date} ${time}</div>
                                <div>${emoji} ${label}: ${log.gamesProcessed} games fetched</div>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('logs-list').innerHTML = logsHtml;
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }

        async function runBackfill() {
            const btn = document.getElementById('btn-backfill');
            const outputBox = document.getElementById('output-box');
            const outputContent = document.getElementById('output-content');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span><span>Running Backfill...</span>';
            outputBox.classList.add('show');
            outputContent.textContent = 'Starting full backfill...\n';
            
            try {
                const response = await fetch('/admin/api/backfill', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    outputContent.textContent += '\n‚úÖ ' + data.message + '\n\n' + data.output;
                    setTimeout(() => refreshStatus(), 1000);
                } else {
                    outputContent.textContent += '\n‚ùå Error: ' + data.error + '\n\n' + data.output;
                }
            } catch (error) {
                outputContent.textContent += '\n‚ùå Error: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üîÑ</span><span>Full Backfill</span>';
            }
        }

        async function runUpdate() {
            const btn = document.getElementById('btn-update');
            const outputBox = document.getElementById('output-box');
            const outputContent = document.getElementById('output-content');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span><span>Updating...</span>';
            outputBox.classList.add('show');
            outputContent.textContent = 'Starting update...\n';
            
            try {
                const response = await fetch('/admin/api/update', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    outputContent.textContent += '\n‚úÖ ' + data.message + '\n\n' + data.output;
                    setTimeout(() => refreshStatus(), 1000);
                } else {
                    outputContent.textContent += '\n‚ùå Error: ' + data.error + '\n\n' + data.output;
                }
            } catch (error) {
                outputContent.textContent += '\n‚ùå Error: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Update Now';
            }
        }

        async function runUpdateWeek() {
            const btn = document.getElementById('btn-update-week');
            const outputBox = document.getElementById('output-box');
            const outputContent = document.getElementById('output-content');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span><span>Updating Week...</span>';
            outputBox.classList.add('show');
            outputContent.textContent = 'Starting week update...\n';
            
            try {
                const response = await fetch('/admin/api/update-week', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    outputContent.textContent += '\n‚úÖ ' + data.message + '\n\n' + data.output;
                    setTimeout(() => refreshStatus(), 1000);
                } else {
                    outputContent.textContent += '\n‚ùå Error: ' + data.error + '\n\n' + data.output;
                }
            } catch (error) {
                outputContent.textContent += '\n‚ùå Error: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Update Week';
            }
        }

        async function updateSchedulerConfig() {
            const interval = parseFloat(document.getElementById('interval-select').value);
            const smartMode = document.getElementById('smart-mode').checked;
            const liveGameInterval = parseInt(document.getElementById('live-game-interval-select').value);
            const pregameWindow = parseInt(document.getElementById('pregame-window-select').value);
            
            try {
                const response = await fetch('/admin/api/scheduler/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval, smartMode, liveGameInterval, pregameWindow })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Scheduler config updated:', data.config);
                }
            } catch (error) {
                console.error('Error updating scheduler config:', error);
            }
        }

        async function toggleScheduler(enabled) {
            try {
                const response = await fetch('/admin/api/scheduler/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                if (data.success) {
                    refreshStatus();
                }
            } catch (error) {
                console.error('Error toggling scheduler:', error);
            }
        }
    </script>
</body>
</html>

